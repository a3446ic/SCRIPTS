/*****************************************************/
/*********** NO HAY PÓLIZAS PARA ESA ANUALIDAD  ******/
/*****************************************************/
    1. BUSCAR EN LA TABLA CARTERA    
        SELECT * FROM EXT.CARTERA WHERE NUM_POLIZA = XXX
    2. INSERT EN LA TABLA CARTERA PARA LA PÓLIZA Y LA ANUALIDAD QUE NOS SOLICITAN
        INSERT INTO EXT.CARTERA
        SELECT TOP 1
			'CREDITO' as RAMO,
			(SELECT EXT.LIB_GLOBAL_CESCE :getProductId( (select lpad(i.IDMODALIDAD, 3, '0') from dummy), '0', (CASE WHEN (i.IDPAIS > 0 AND i.IDPAIS <= 52) THEN 116 ELSE i.IDPAIS END), i.NUM_POLIZA).productId FROM DUMMY) as IDPRODUCT,
			i.NUM_POLIZA as NUM_POLIZA,
			i.IDMODALIDAD as IDMODALIDAD,
			NULL as IDSUBMODALIDAD,
			0 as NUM_FIANZA,
			NULL as NUM_EXPEDIENTE,
			NULL as NUM_AVAL_HOST,
			i.NUM_ANUALIDAD as NUM_ANUALIDAD,
			i.FECHA_EMISION as FECHA_EMISION,
			i.FECHA_EFECTO as FECHA_EFECTO,
			i.FECHA_VENCIMIENTO FECHA_VENCIMIENTO,
			(CASE WHEN (i.IDPAIS > 0 AND i.IDPAIS <= 52) THEN 116 ELSE i.IDPAIS END) as IDPAIS ,
			i.PRIMA_PROVISIONAL_INT as PRIMA_PROVISIONAL_INT,
			i.PRIMA_PROVISIONAL_EXT as PRIMA_PROVISIONAL_EXT,
			i.IDDIVISA_MERCADO_INT as IDDIVISA_INT,
			i.IDDIVISA_MERCADO_EXT as IDDIVISA_EXT,
			NULL as IDDIVISA_COBERTURA,
			i.PRIMA_MIN_MERCADO_INT as PRIMA_MIN_INT,
			i.PRIMA_MIN_MERCADO_EXT as PRIMA_MIN_EXT,
			lpad(IDMEDIADOR,4,'0') as COD_MEDIADOR,
			lpad(IDSUBCLAVE,4,'0')  as COD_SUBCLAVE,
			( 100 * i.PORC_INTERMEDIACION) as PORC_INTERMEDIACION,
			i.FECHA_EFECTO as FECHA_INI,
			'2200-01-01' as FECHA_FIN,
			NULL as P_ESPECIAL_EMISION,
			NULL as P_ESPECIAL_RENOVACION,
			i.IDFISCAL_TOMADOR NIF_TOMADOR,
			'' NOMBRE_TOMADOR, --NOMBRE_TOMADOR  -- NO VIENE EN EL FICHERO
			NULL as FECHA_EFECTO_TRASPASO,
			1 as MEDIADOR_PRINCIPAL_CIC,
			1 AS ACTIVO,
			CURRENT_TIMESTAMP as CREATEDATE,
			CURRENT_TIMESTAMP as MODIF_DATE,
			'MANUAL' as MODIF_USER,
			BATCHNAME as MODIF_SOURCE
        FROM EXT.EXT_MOVIMIENTO_CARTERA_CREDITO_HIST i 
        WHERE NUM_POLIZA= XXX
        AND NUM_ANUALIDAD= AA
    
    3.REPROCESAR
        CALL "EXT"."SP_REPROCESO_MOVIMIENTO_RECIBOS"('ID1,ID2...IDN')  -- IDX: SE OBTIENEN DE LA EXCEL

    4. COMPROBAR
        SELECT * FROM EXT.CSE_DEBUG WHERE  DATETIME>=  'YYYY-MM-DD HH:MM'

/*****************************************************/
/*************** FECHA EFECTO NO COINCIDE  ***********/
/*****************************************************/

    1. BUSCAR EN LA TABLA CARTERA    
        SELECT * FROM EXT.CARTERA WHERE NUM_POLIZA = XXX

    2. INSERT EN LA TABLA CARTERA LA PÓLIZA 
        INSERT INTO EXT.CARTERA
        SELECT TOP 1
			'CREDITO' as RAMO,
			(SELECT EXT.LIB_GLOBAL_CESCE :getProductId( (select lpad(i.IDMODALIDAD, 3, '0') from dummy), '0', (CASE WHEN (i.IDPAIS > 0 AND i.IDPAIS <= 52) THEN 116 ELSE i.IDPAIS END), i.NUM_POLIZA).productId FROM DUMMY) as IDPRODUCT,
			i.NUM_POLIZA as NUM_POLIZA,
			i.IDMODALIDAD as IDMODALIDAD,
			NULL as IDSUBMODALIDAD,
			0 as NUM_FIANZA,
			NULL as NUM_EXPEDIENTE,
			NULL as NUM_AVAL_HOST,
			i.NUM_ANUALIDAD as NUM_ANUALIDAD,
			i.FECHA_EMISION as FECHA_EMISION,
			i.FECHA_EFECTO as FECHA_EFECTO,
			i.FECHA_VENCIMIENTO FECHA_VENCIMIENTO,
			(CASE WHEN (i.IDPAIS > 0 AND i.IDPAIS <= 52) THEN 116 ELSE i.IDPAIS END) as IDPAIS ,
			i.PRIMA_PROVISIONAL_INT as PRIMA_PROVISIONAL_INT,
			i.PRIMA_PROVISIONAL_EXT as PRIMA_PROVISIONAL_EXT,
			i.IDDIVISA_MERCADO_INT as IDDIVISA_INT,
			i.IDDIVISA_MERCADO_EXT as IDDIVISA_EXT,
			NULL as IDDIVISA_COBERTURA,
			i.PRIMA_MIN_MERCADO_INT as PRIMA_MIN_INT,
			i.PRIMA_MIN_MERCADO_EXT as PRIMA_MIN_EXT,
			lpad(IDMEDIADOR,4,'0') as COD_MEDIADOR,
			lpad(IDSUBCLAVE,4,'0')  as COD_SUBCLAVE,
			( 100 * i.PORC_INTERMEDIACION) as PORC_INTERMEDIACION,
			i.FECHA_EFECTO as FECHA_INI,
			'2200-01-01' as FECHA_FIN,
			NULL as P_ESPECIAL_EMISION,
			NULL as P_ESPECIAL_RENOVACION,
			i.IDFISCAL_TOMADOR NIF_TOMADOR,
			'' NOMBRE_TOMADOR, --NOMBRE_TOMADOR  -- NO VIENE EN EL FICHERO
			NULL as FECHA_EFECTO_TRASPASO,
			1 as MEDIADOR_PRINCIPAL_CIC,
			1 AS ACTIVO,
			CURRENT_TIMESTAMP as CREATEDATE,
			CURRENT_TIMESTAMP as MODIF_DATE,
			'MANUAL' as MODIF_USER,
			BATCHNAME as MODIF_SOURCE
        FROM EXT.EXT_MOVIMIENTO_CARTERA_CREDITO_HIST i 
        WHERE NUM_POLIZA= XXX
        AND NUM_ANUALIDAD= AA
    
    3. DESACTIVAR REGISTRO REMPLAZADO
        UPDATE EXT.CARTERA SET ACTIVO=0, MODIF_USER='MANUAL', MODIF_DATE=CURRENT_TIMESTAMP WHERE NUM_POLIZA = XXX AND NUM_ANUALIDAD = AA AND FECHA_EFECTO = 'YYY-MM-DD'
    
    4. REPROCESAR
        CALL "EXT"."SP_REPROCESO_MOVIMIENTO_RECIBOS"('ID1,ID2...IDN')  -- IDX: SE OBTIENEN DE LA EXCEL

    5. COMPROBAR
        SELECT * FROM EXT.CSE_DEBUG WHERE  DATETIME>=  'YYYY-MM-DD HH:MM'



/*****************************************************/
/****** PÓLIZA ANULADA PARA LA ANUALIDAD X   *********/
/*****************************************************/

    1. BUSCAR EN LA TABLA CARTERA    
        SELECT * FROM EXT.CARTERA WHERE NUM_POLIZA = XXX

    2. MODIFICAR ACTIVO PARA LA PÓLIZA Y ANUALIDAD SOLICITADA
        UPDATE EXT.CARTERA SET ACTIVO=1, MODIF_USER='MANUAL', MODIF_DATE=CURRENT_TIMESTAMP WHERE NUM_POLIZA = XXX AND NUM_ANUALIDAD = AA

    3.REPROCESAR
            CALL "EXT"."SP_REPROCESO_MOVIMIENTO_RECIBOS"('ID1,ID2...IDN')  -- IDX: SE OBTIENEN DE LA EXCEL
    
    4. COMPROBAR
        SELECT * FROM EXT.CSE_DEBUG WHERE  DATETIME>=  'YYYY-MM-DD HH:MM'
    